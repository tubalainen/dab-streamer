services:
  dab-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: dab-server
    devices:
      - /dev/bus/usb:/dev/bus/usb
    volumes:
      - dab-data:/data
    environment:
      - MGMT_PORT=8888
      - WELLE_PORT=${WELLE_PORT:-7979}
      - SCAN_TIMEOUT=${SCAN_TIMEOUT:-10}
      - DEFAULT_CHANNEL=${DEFAULT_CHANNEL:-5A}
      - DEFAULT_GAIN=${DEFAULT_GAIN:--1}
    networks:
      - dab-net
    restart: unless-stopped
    mem_limit: 512m
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8888/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: dab-api
    depends_on:
      dab-server:
        condition: service_healthy
    volumes:
      - dab-data:/data
    environment:
      - API_PORT=${API_PORT:-3000}
      - WELLE_PORT=${WELLE_PORT:-7979}
      - DAB_SERVER_HOST=dab-server
      - DAB_SERVER_MGMT_PORT=8888
      - SCAN_TIMEOUT=${SCAN_TIMEOUT:-10}
      - DEFAULT_CHANNEL=${DEFAULT_CHANNEL:-5A}
      - LOCK_REAPER_INTERVAL=${LOCK_REAPER_INTERVAL:-30}
      - KEEP_SCAN_DATA_ON_RESET=${KEEP_SCAN_DATA_ON_RESET:-true}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-}
    networks:
      - dab-net
    restart: unless-stopped
    mem_limit: 256m
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:${API_PORT:-3000}/api/status"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  web-ui:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: dab-web
    depends_on:
      api:
        condition: service_healthy
    ports:
      - "${WEB_PORT:-8080}:80"
    environment:
      - API_PORT=${API_PORT:-3000}
    networks:
      - dab-net
    restart: unless-stopped
    mem_limit: 128m
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:80/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  dab-net:
    driver: bridge

volumes:
  dab-data:
    driver: local
